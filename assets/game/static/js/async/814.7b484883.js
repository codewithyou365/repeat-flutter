"use strict";(self.webpackChunktyping=self.webpackChunktyping||[]).push([["814"],{235:function(t,e,s){s.r(e),s.d(e,{default:()=>p});var i=s("881"),a=s("946"),r=s("687"),n=s("151"),o=s("438");class l{constructor(t,e){(0,o._)(this,"lastId",void 0),(0,o._)(this,"pageSize",void 0),this.pageSize=t,this.lastId=e}}var h=s("572"),u=s("987");let d={class:"score-card"},c={class:"row"},_={class:"remark"},g={class:"row"},T={class:"time"},N={class:"balance"},S={key:1,class:"score-outline"},C=(0,i.aZ)({__name:"game_score",setup(t){let e=(0,i.iH)(!1),s=(0,i.iH)(""),{t:o}=(0,a.QT)(),C=(0,i.iH)([]),p=(0,i.iH)(void 0),I=(0,i.iH)(!1),O=(0,i.iH)(!0),E=(0,i.iH)(!1);(0,i.bv)(async()=>{I.value=!0,E.value=!0,await w()});let v=t=>t>0?`+${t}`:`${t}`,w=async()=>{I.value=!0;let t=new r.cf({path:n.y$.gameUserScoreHistory,data:new l(20,p.value)}),i=await r.Lp.node.send(t);try{if(i.error){e.value=!0,s.value=o(i.error);return}let t=i.data.history;if(t.length<20&&(O.value=!1),t.length>0){for(let e of(p.value=t[t.length-1].id,t)){var a;(null===(a=e.remark)||void 0===a?void 0:a.startsWith("i:"))&&(e.remark=o(e.remark.substring(2)))}C.value.push(...t)}C.value.length>100&&(O.value=!1)}finally{E.value=!1,I.value=!1}},m=async()=>{E.value=!0,C.value=[],p.value=void 0,O.value=!0,await w(),h.C.text("",{title:o("loadingSuccess")})},R=()=>history.back(),f=()=>{console.log("event cancel")},y=()=>{console.log("event ok")};return(t,a)=>{let r=(0,i.up)("router-link"),n=(0,i.up)("nut-navbar"),l=(0,i.up)("nut-infinite-loading"),h=(0,i.up)("nut-cell"),p=(0,i.up)("nut-pull-refresh"),k=(0,i.up)("nut-dialog");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(n,{title:(0,i.SU)(o)("score"),"left-show":"",onClickBack:R},{right:(0,i.w5)(()=>[(0,i.Wm)(r,{to:"/game_score_minus"},{default:(0,i.w5)(()=>[(0,i.Wm)((0,i.SU)(u.k3),{width:"16px"})]),_:1})]),_:1},8,["title"]),(0,i.Wm)(p,{modelValue:E.value,"onUpdate:modelValue":a[1]||(a[1]=t=>E.value=t),"loading-txt":(0,i.SU)(o)("loading"),"pulling-txt":(0,i.SU)(o)("pullToRefresh"),"loosing-txt":(0,i.SU)(o)("looseToRefresh"),"complete-txt":(0,i.SU)(o)("loadingSuccess"),onRefresh:m},{default:(0,i.w5)(()=>[C.value.length>0?((0,i.wg)(),(0,i.j4)(l,{key:0,modelValue:I.value,"onUpdate:modelValue":a[0]||(a[0]=t=>I.value=t),"has-more":O.value,"load-txt":(0,i.SU)(o)("loading"),"load-more-txt":(0,i.SU)(o)("loadMoreTxt"),onLoadMore:w},{default:(0,i.w5)(()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(C.value,t=>((0,i.wg)(),(0,i.iD)("div",{class:"score-outline",key:t.id},[(0,i._)("div",d,[(0,i._)("div",c,[(0,i._)("div",_,(0,i.zw)(t.remark),1),(0,i._)("div",{class:(0,i.C_)(["score",{positive:t.inc>0,negative:t.inc<0}])},(0,i.zw)(v(t.inc)),3)]),(0,i._)("div",g,[(0,i._)("div",T,(0,i.zw)(t.createTime),1),(0,i._)("div",N,(0,i.zw)((0,i.SU)(o)("balance")+t.after),1)])])]))),128))]),_:1},8,["modelValue","has-more","load-txt","load-more-txt"])):((0,i.wg)(),(0,i.iD)("div",S,[(0,i.Wm)(h,null,{default:(0,i.w5)(()=>[(0,i.Uk)((0,i.zw)((0,i.SU)(o)("noData")),1)]),_:1})]))]),_:1},8,["modelValue","loading-txt","pulling-txt","loosing-txt","complete-txt"]),(0,i.Wm)(k,{visible:e.value,"onUpdate:visible":a[2]||(a[2]=t=>e.value=t),title:(0,i.SU)(o)("tips"),content:s.value,okText:(0,i.SU)(o)("confirm"),"no-cancel-btn":!0,cancelText:(0,i.SU)(o)("cancel"),onOk:y,onCancel:f},null,8,["visible","title","content","okText","cancelText"])],64)}}}),p=C},687:function(t,e,s){s.d(e,{HM:function(){return l},HQ:function(){return a},Lp:function(){return N},cf:function(){return o},wJ:function(){return d}});var i=s(438);let a=`wss://${window.location.hostname}:${window.location.port}`,r={REQUEST:0,RESPONSE:1},n={age:"age"};class o{static fromJson(t){return new o({path:t.path??"",headers:t.headers||new Map,data:t.data??""})}constructor({path:t="",headers:e=new Map,data:s=""}={}){(0,i._)(this,"path",void 0),(0,i._)(this,"headers",void 0),(0,i._)(this,"data",void 0),this.path=t,this.headers=e,this.data=s}}class l{static fromJson(t){return new l({headers:t.headers||new Map,data:t.data??"",error:t.error??"",status:t.status??200})}constructor({headers:t=new Map,data:e="",error:s="",status:a=200}={}){(0,i._)(this,"headers",void 0),(0,i._)(this,"data",void 0),(0,i._)(this,"error",void 0),(0,i._)(this,"status",void 0),this.headers=t,this.data=e,this.error=s,this.status=a}}class h{static fromJson(t){return new h({type:t.type,id:t.id||0,age:t.age||0,request:t.request?o.fromJson(t.request):null,response:t.response?l.fromJson(t.response):null})}constructor({type:t=r.REQUEST,id:e=0,age:s=0,request:a=null,response:n=null}={}){(0,i._)(this,"type",void 0),(0,i._)(this,"id",void 0),(0,i._)(this,"age",void 0),(0,i._)(this,"request",void 0),(0,i._)(this,"response",void 0),this.type=t,this.id=e,this.age=s,this.request=a,this.response=n}}class u{receive(t){if(t.age!==this.age){console.log(`[ws] ignoring message - age mismatch: ${t.age} vs ${this.age}`);return}let e=this.sendId2Res.get(t.id);if(e){let s=new Map;s.set(n.age,`${this.age}`),t.response.headers=s,e.resolve(t.response),this.sendId2Res.delete(t.id)}this.sendId2Log.get(t.id)&&(console.log("[ws] recv :",t),this.sendId2Log.delete(t.id))}async send(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this.sendId++;let s=this.sendId,i=this.age,a=new h({id:s,age:i,type:r.REQUEST,request:t});e&&console.log("[ws] send :",a),this.webSocket.send(JSON.stringify(a));let o=this._createCompleter();this.sendId2Res.set(s,o),this.sendId2Log.set(s,e);let u=setTimeout(()=>{if(this.sendId2Res.delete(s)){this.sendId2Log.delete(s);let t=new Map;t.set(n.age,`${i}`),o.resolve(new l({headers:t,error:"timeout",status:504}))}},1e4);try{return await o.promise}finally{clearTimeout(u),this.sendId2Res.delete(s),this.sendId2Log.delete(s)}}_createCompleter(){let t,e;return{promise:new Promise((s,i)=>{t=s,e=i}),resolve:t,reject:e}}constructor(t,e){(0,i._)(this,"sendId",void 0),(0,i._)(this,"sendId2Res",void 0),(0,i._)(this,"sendId2Log",void 0),(0,i._)(this,"webSocket",void 0),(0,i._)(this,"age",void 0),this.sendId=0,this.sendId2Res=new Map,this.sendId2Log=new Map,this.webSocket=t,this.age=e}}let d={INIT:0,CONNECT_START:1,CONNECT_FAILED:2,CONNECT_FINISH:3,CONNECT_CLOSE:4,STOP_START:5,STOP_FINISH:6,STOP_FOR_RECONNECT_START:7,STOP_FOR_RECONNECT_FINISH:8},c=new Map([[0,"INIT"],[1,"CONNECT_START"],[2,"CONNECT_FAILED"],[3,"CONNECT_FINISH"],[4,"CONNECT_CLOSE"],[5,"STOP_START"],[6,"STOP_FINISH"],[7,"STOP_FOR_RECONNECT_START"],[8,"STOP_FOR_RECONNECT_FINISH"]]),_=new Map;function g(t,e,s){let i=new Map;for(let t of s)i.set(t,!0);_.set(t,{to:t,incAge:e,from:i})}g(d.INIT,!1,[]),g(d.CONNECT_START,!0,[d.INIT,d.STOP_FOR_RECONNECT_FINISH,d.CONNECT_CLOSE]),g(d.CONNECT_FAILED,!1,[d.CONNECT_START,d.CONNECT_FINISH]),g(d.CONNECT_FINISH,!1,[d.CONNECT_START]),g(d.CONNECT_CLOSE,!0,[d.CONNECT_FINISH]),g(d.STOP_START,!0,[d.CONNECT_FAILED,d.CONNECT_FINISH]),g(d.STOP_FINISH,!0,[d.STOP_START]),g(d.STOP_FOR_RECONNECT_START,!0,[d.CONNECT_FAILED,d.CONNECT_FINISH]),g(d.STOP_FOR_RECONNECT_FINISH,!0,[d.STOP_FOR_RECONNECT_START]);class T{constructor(){(0,i._)(this,"url",""),(0,i._)(this,"statusChange",()=>{}),(0,i._)(this,"heartSender",async()=>new l({status:200})),(0,i._)(this,"reason","")}}let N=new class t{async _loopHeart(){this.heart&&clearTimeout(this.heart);let t=-1;try{let e=await this.heartSender();t=parseInt(e.headers.get(n.age)??"-1"),200===e.status&&""===e.error?this.heart=setTimeout(()=>{this._loopHeart()},2e3):t===this.age&&this.stop(!0,"heart error:"+e.error)}catch(e){t===this.age&&this.stop(!0,"heart exception")}}async send(t){return this.node?await this.node.send(t):null}start(t,e,s){if(this.status!==d.INIT&&this.status!==d.CONNECT_CLOSE&&this.status!==d.STOP_FOR_RECONNECT_FINISH)return this.logger(`[ws] start: status error :${c.get(this.status)}`),!1;{let i=new T;return i.url=t,i.statusChange=e,i.heartSender=s,this.setStatus(d.CONNECT_START,i),!0}}stop(t,e){if(this.status!=d.CONNECT_FAILED&&this.status!=d.CONNECT_FINISH)return this.logger(`[ws] stop: status error :${c.get(this.status)} ${e}`),!1;{let s=new T;return s.reason=e,t?this.setStatus(d.STOP_FOR_RECONNECT_START,s):this.setStatus(d.STOP_START,s),!0}}_close(){this.node.webSocket.close()}_start(t,e,s){this.url=t,this.statusChange=e,this.heartSender=s;let i=new WebSocket(t);this.node=new u(i,this.age),i.onmessage=async t=>{if(this.status===d.CONNECT_FINISH)try{let e=t.data,s=h.fromJson(JSON.parse(e));if(s.type===r.RESPONSE){if(s.age!==this.age)return;this.node.receive(s)}else s.type===r.REQUEST?(console.log("[ws] recv :",s),await this._responseHandler(this.controllers,s,i)):(console.log("[ws] recv :",s),this.logger(`Unknown message type: ${s.type}`))}catch(t){this.logger(`Error handling WebSocket message: ${t}`)}},i.onclose=t=>{this.status===d.CONNECT_FINISH?this.setStatus(d.CONNECT_CLOSE,null):this.status===d.STOP_START?this.setStatus(d.STOP_FINISH,null):this.status===d.STOP_FOR_RECONNECT_START?this.setStatus(d.STOP_FOR_RECONNECT_FINISH,null):this.logger(`[ws] socket.onclose: status error :${c.get(this.status)}`)},i.onerror=t=>{this.status==d.CONNECT_START||this.status==d.CONNECT_FINISH?this.setStatus(d.CONNECT_FAILED,null):this.logger(`[ws] socket.onerror: status error :${c.get(this.status)}`)},i.onopen=()=>{this.status==d.CONNECT_START?this.setStatus(d.CONNECT_FINISH,null):this.logger(`[ws] socket.onopen: status error :${c.get(this.status)}`)}}setStatus(t,e){let s=_.get(t);if(void 0===s)throw Error(`Unknown status: ${t}`);if(!s.from.get(this.status)){this.logger(`[ws] status error : cant from ${c.get(this.status)} to ${c.get(t)} ${null==e?void 0:e.reason}`);return}switch(s.incAge&&this.age++,this.logger(`[ws] status from ${c.get(this.status)} to ${c.get(t)} ${null==e?void 0:e.reason}`),this.status=t,t){case d.CONNECT_START:this._start(e.url,e.statusChange,e.heartSender);break;case d.CONNECT_FAILED:this.stop(!0,"connect failed");break;case d.CONNECT_FINISH:this._loopHeart();break;case d.STOP_FOR_RECONNECT_START:case d.STOP_START:this._close();break;case d.STOP_FINISH:case d.STOP_FOR_RECONNECT_FINISH:case d.CONNECT_CLOSE:this.heart&&clearTimeout(this.heart),this.retry&&clearTimeout(this.retry),(t===d.STOP_FOR_RECONNECT_FINISH||t===d.CONNECT_CLOSE)&&(this.retry=setTimeout(()=>{this.start(this.url,this.statusChange,this.heartSender)},1e3))}this.statusChange(this.status)}async _responseHandler(t,e,s){let i;let a=e.request,n=a&&t.get(a.path);if(n)try{i=await n(a)||new l({status:501})}catch(e){let t;i=new l({status:500,error:t=e instanceof Error?e.message:String(e)})}else i=new l({status:404});let o=new h({id:e.id,type:r.RESPONSE,response:i});s.send(JSON.stringify(o))}constructor(t=console.log){(0,i._)(this,"logger",void 0),(0,i._)(this,"age",0),(0,i._)(this,"node",void 0),(0,i._)(this,"status",d.INIT),(0,i._)(this,"url",""),(0,i._)(this,"retry",null),(0,i._)(this,"statusChange",()=>{}),(0,i._)(this,"controllers",void 0),(0,i._)(this,"heart",null),(0,i._)(this,"heartSender",async()=>new l({status:200})),this.logger=t,this.node=null,this.controllers=new Map}}},151:function(t,e,s){s.d(e,{D$:function(){return n},_q:function(){return h},bY:function(){return l},ot:function(){return o},y$:function(){return r}});var i,a=s(438);let r={kick:"/api/kick",refreshGame:"/api/refreshGame",heart:"/api/heart",loginOrRegister:"/api/loginOrRegister",entryGame:"/api/entryGame",gameUserHistory:"/api/gameUserHistory",gameUserScore:"/api/gameUserScore",gameUserScoreHistory:"/api/gameUserScoreHistory",gameUserScoreMinus:"/api/gameUserScoreMinus",typeGameSettings:"/api/typeGameSettings",typeVerseContent:"/api/typeVerseContent",blankItRightSettings:"/api/blankItRightSettings",blankItRightContent:"/api/blankItRightContent",blankItRightBlank:"/api/blankItRightBlank",blankItRightSubmit:"/api/blankItRightSubmit",submit:"/api/submit"};class n{static toGameType(t){switch(t){case n.TYPE.code:return n.TYPE;case n.BLANK_IT_RIGHT.code:return n.BLANK_IT_RIGHT;case n.INPUT.code:return n.INPUT;default:return n.NONE}}constructor(t,e){(0,a._)(this,"code",void 0),(0,a._)(this,"path",void 0),this.code=t,this.path=e}}(0,a._)(n,"NONE",new n(0,"")),(0,a._)(n,"TYPE",new n(1,"/game/type-game")),(0,a._)(n,"BLANK_IT_RIGHT",new n(2,"/game/blank-it-right-game")),(0,a._)(n,"INPUT",new n(3,"/game/input-game"));class o{static from(t){let e=new o;return e.list=t.list,e.tips=t.tips,e}constructor(){(0,a._)(this,"list",void 0),(0,a._)(this,"tips",void 0),this.list=[],this.tips=[]}}class l{static from(t){let e=new l;return e.gameId=t.gameId||0,e.prevId=t.prevId||0,e.input=t.input||"",e}constructor(){(0,a._)(this,"gameId",void 0),(0,a._)(this,"prevId",void 0),(0,a._)(this,"input",void 0),this.gameId=0,this.prevId=0,this.input=""}}var h=((i={})[i.word=0]="word",i[i.single=1]="single",i[i.all=2]="all",i)}}]);