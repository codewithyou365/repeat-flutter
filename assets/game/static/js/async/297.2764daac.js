"use strict";(self.webpackChunktyping=self.webpackChunktyping||[]).push([["297"],{609:function(e,t,r){r.r(t),r.d(t,{default:()=>q});var l,o=r("464"),a=r("219"),n=r("759"),s=r("687"),u=r("151"),i=r("438");var d=((l={})[l.none=0]="none",l[l.selectRule=1]="selectRule",l[l.started=2]="started",l[l.finished=3]="finished",l);class c{static fromJson(e){let t=new c;return e&&(t.rightCount="number"==typeof e.rightCount?e.rightCount:0,t.errorCount="number"==typeof e.errorCount?e.errorCount:0,t.score="number"==typeof e.score?e.score:0),t}constructor(){(0,i._)(this,"rightCount",0),(0,i._)(this,"errorCount",0),(0,i._)(this,"score",0)}}class v{constructor(e){(0,i._)(this,"start",void 0),(0,i._)(this,"end",void 0),(0,i._)(this,"word",void 0),(0,i._)(this,"colorIndex",void 0),(0,i._)(this,"right",void 0),this.start=e.start,this.end=e.end,this.word=e.word??"",this.colorIndex=e.colorIndex??-1,this.right=e.right??!1}}class p{static fromJson(e){let t=new p;return t.maxScore=e.maxScore,t.verseId=e.verseId,void 0!==e.gameStep&&("string"==typeof e.gameStep?t.gameStep=d[e.gameStep]??0:t.gameStep=e.gameStep),t.colorIndexToUserId=Array.isArray(e.colorIndexToUserId)?e.colorIndexToUserId:[[],[],[]],t.userIds=Array.isArray(e.userIds)?e.userIds:[],t.userIdToUserName=e.userIdToUserName&&"object"==typeof e.userIdToUserName?e.userIdToUserName:{},t.currUserIndex="number"==typeof e.currUserIndex?e.currUserIndex:-1,t.content=e.content||"",t.answer=e.answer||"",t.colorIndexToSelectedContentIndex=Array.isArray(e.colorIndexToSelectedContentIndex)?e.colorIndexToSelectedContentIndex:[],Array.isArray(e.colorIndexToStat)&&(t.colorIndexToStat=e.colorIndexToStat.map(e=>c.fromJson(e))),t.userIdToScore=e.userIdToScore,t}getColorIndexToWords(){let e=[];for(let t=0;t<3;t++){let r=Array.from(new Set(this.colorIndexToSelectedContentIndex[t]));e.push(...this.extractConsecutiveWord(r,t))}for(let t of(e.sort((e,t)=>e.start-t.start),e))t.word=this.content.substring(t.start,t.end+1);return e}getAnswerWords(){let e=[];if(!this.answer||!this.content)return e;let t=this.answer.split(" "),r=0;for(let l of t){if(!l)continue;let t=r,o=r+l.length-1;e.push(new v({start:t,end:o,word:l})),r+=l.length}return e}scoreEachChar(){return(this.maxScore/this.content.length).toFixed(2)}getResult(){if(!this.content.length)return[];let e=this.getAnswerWords(),t=this.getColorIndexToWords();for(let r of t){let t=!1;for(let l of e)if(l.start===r.start){t=!0,r.right=l.word===r.word;break}!t&&(r.right=!1)}return t}extractConsecutiveWord(e,t){if(!e.length)return[];let r=[...e].sort((e,t)=>e-t),l=[],o=r[0],a=o;for(let e=1;e<r.length;e++)r[e]===a+1?a=r[e]:(l.push(new v({start:o,end:a,colorIndex:t})),o=a=r[e]);return l.push(new v({start:o,end:a,colorIndex:t})),l}constructor(){(0,i._)(this,"maxScore",10),(0,i._)(this,"verseId",-1),(0,i._)(this,"gameStep",0),(0,i._)(this,"colorIndexToUserId",[[],[],[]]),(0,i._)(this,"userIds",[]),(0,i._)(this,"userIdToUserName",{}),(0,i._)(this,"currUserIndex",-1),(0,i._)(this,"content",""),(0,i._)(this,"answer",""),(0,i._)(this,"colorIndexToSelectedContentIndex",[[],[],[]]),(0,i._)(this,"colorIndexToStat",[new c,new c,new c]),(0,i._)(this,"userIdToScore",{})}}var w=r("118"),f=r("480"),g=r("901");let h={key:0},m={class:"player-order"},I={key:0,class:"separator"},S=(0,o.aZ)({__name:"player",props:{userIds:{},userIdToUserName:{},currentUserId:{},currUserIndex:{},gameStep:{},getUserColor:{type:Function}},setup(e){let{t}=(0,w.QT)(),r=(0,o.f3)("editorContent"),l=(0,o.f3)("editorEnable"),a=(0,o.f3)("overlayVisible"),n=(0,o.f3)("tipDialogVisible"),i=(0,o.f3)("tipDialogContent"),c=t=>t===e.currUserIndex&&e.gameStep===d.started,v=async()=>{let e=null;try{a.value=!0,e=await s.Lp.send(new s.cf({path:u.y$.wordSlicerEdit,data:r.value}))}catch(e){n.value=!0,i.value=String(e)}finally{null!=e&&e.error&&(n.value=!0,i.value=t(e.error)),a.value=!1}},p=t=>{let r=e.getUserColor(t);return{borderLeft:r?`8px solid ${r}`:"none",paddingLeft:r?"6px":"8px"}};return(e,a)=>{let n=(0,o.up)("nut-textarea"),s=(0,o.up)("nut-button"),u=(0,o.up)("nut-cell");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o.SU)(l)?((0,o.wg)(),(0,o.iD)("div",h,[(0,o.Wm)(n,{modelValue:(0,o.SU)(r),"onUpdate:modelValue":a[0]||(a[0]=e=>(0,o.dq)(r)?r.value=e:null),rows:3,autosize:""},null,8,["modelValue"]),(0,o.Wm)(s,{shape:"square",type:"primary",block:"",onClick:v},{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("refreshAfterModify")),1)]),_:1})])):(0,o.kq)("",!0),(0,o.Wm)(u,null,{default:(0,o.w5)(()=>[(0,o._)("div",m,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.userIds,(t,r)=>((0,o.wg)(),(0,o.iD)(o.HY,{key:t},[(0,o._)("span",{class:(0,o.C_)(["player-tag",{"is-me":t===e.currentUserId,"is-active":c(r)}]),style:(0,o.j5)(p(t))},(0,o.zw)(r+1)+". "+(0,o.zw)(e.userIdToUserName[t]),7),r<e.userIds.length-1?((0,o.wg)(),(0,o.iD)("span",I," ➡️ ")):(0,o.kq)("",!0)],64))),128))])]),_:1})],64)}}});var y=r("906");let U=(0,y.default)(S,[["__scopeId","data-v-1fe7032b"]]),x={class:"lobby"},_=(0,o.aZ)({__name:"lobby",setup(e,t){let{expose:r}=t,{t:l}=(0,w.QT)(),n=(0,f.oR)(),i=(0,o.iH)(new p),d=(0,o.iH)(""),c=[l("orange"),l("violet"),l("cyan")],v=["#f1ac40","#e18be5","#78fbfd"],h=(0,o.f3)("overlayVisible"),m=(0,o.f3)("tipDialogVisible"),I=(0,o.f3)("tipDialogContent"),S=(0,o.Fl)(()=>(0,g.H)(n.getters.currentUserId)),y=e=>{let t=i.value.colorIndexToUserId[e]||[];if(0===t.length)return"";let r=t.map(e=>i.value.userIdToUserName[e]||`User:${e}`);return`(${r.join(", ")})`},_=(0,o.Fl)(()=>i.value.userIds.length>0),b=e=>{s.Lp.send(new s.cf({path:u.y$.wordSlicerSelectRole,data:{index:parseInt(e)}}))},C=async()=>{h.value=!0;let e=await s.Lp.send(new s.cf({path:u.y$.wordSlicerStartGame}));e.error&&(m.value=!0,I.value=l(e.error)),h.value=!1},k=()=>{let e=(0,g.H)(n.getters.currentUserId),t=i.value.colorIndexToUserId.findIndex(t=>t.includes(e));-1!==t&&(d.value=t.toString())};(0,o.bv)(()=>{(0,a.$x)().on(a.B_.WordSlicerStatusUpdate,e=>{i.value=e,k()})}),(0,o.Jd)(()=>{(0,a.$x)().off(a.B_.WordSlicerStatusUpdate)});let T=e=>{let t=i.value.colorIndexToUserId.findIndex(t=>t.includes(e));return -1!==t?v[t]:""};return r({initUser(e){i.value=p.fromJson(e),k()}}),(e,t)=>{let r=(0,o.up)("nut-cell"),a=(0,o.up)("nut-radio"),n=(0,o.up)("nut-radio-group"),s=(0,o.up)("nut-button");return(0,o.wg)(),(0,o.iD)("div",x,[(0,o.Wm)(U,{"user-ids":i.value.userIds,"user-id-to-user-name":i.value.userIdToUserName,"current-user-id":S.value,"curr-user-index":i.value.currUserIndex,"game-step":i.value.gameStep,"get-user-color":T},null,8,["user-ids","user-id-to-user-name","current-user-id","curr-user-index","game-step"]),(0,o.Wm)(r,null,{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(l)("wordSlicerSelectRole")),1)]),_:1}),(0,o.Wm)(r,null,{default:(0,o.w5)(()=>[(0,o.Wm)(n,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=e=>d.value=e),onChange:b},{default:(0,o.w5)(()=>[((0,o.wg)(),(0,o.iD)(o.HY,null,(0,o.Ko)(c,(e,t)=>(0,o.Wm)(a,{key:t,label:t.toString()},{default:(0,o.w5)(()=>[(0,o._)("span",{style:(0,o.j5)({color:v[t]})},(0,o.zw)(e)+" "+(0,o.zw)(y(t)),5)]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"])]),_:1}),_.value?(0,o.kq)("",!0):((0,o.wg)(),(0,o.j4)(r,{key:0},{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(l)("minPlayersRequired")),1)]),_:1})),_.value?((0,o.wg)(),(0,o.j4)(r,{key:1},{default:(0,o.w5)(()=>[(0,o.Wm)(s,{shape:"square",type:"primary",onClick:C,disabled:!_.value},{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(l)("startGame")),1)]),_:1},8,["disabled"])]),_:1})):(0,o.kq)("",!0)])}}}),b=(0,y.default)(_,[["__scopeId","data-v-40b7eb84"]]);var C=r("40");let k={class:"lobby"},T={key:0,class:"actions"},W={key:1},z={key:2},D=(0,o.aZ)({__name:"game",setup(e){let{t}=(0,w.QT)(),r=(0,f.oR)(),l=(0,o.iH)(new p),n=(0,o.iH)([]),i=(0,o.iH)(),c=[t("orange"),t("violet"),t("cyan")],v=["#f1ac40","#e18be5","#78fbfd"],h=(0,o.f3)("overlayVisible"),m=(0,o.f3)("tipDialogVisible"),I=(0,o.f3)("tipDialogContent"),S=(0,o.Fl)(()=>t("eachCharScore",{score:l.value.scoreEachChar()})),y=(0,o.Fl)(()=>(0,g.H)(r.getters.currentUserId)),x=(0,o.Fl)(()=>l.value.gameStep!=d.finished&&l.value.userIds[l.value.currUserIndex]===y.value),_=e=>l.value.colorIndexToUserId.findIndex(t=>t.includes(e)),b=e=>{let t=_(e);return -1!==t?v[t]:"#999"},D=e=>l.value.userIdToScore[e],H=(0,o.Fl)(()=>x.value?b(l.value.userIds[l.value.currUserIndex]):""),$=async()=>{if(!i.value)return;h.value=!0;let e=null;try{let r=i.value.getContentIndexToColor();if(!r)return;let o=Object.keys(r).map(Number).filter(e=>!n.value.includes(e)).sort((e,t)=>e-t);if(0===o.length){e=await s.Lp.send(new s.cf({path:u.y$.wordSlicerSubmit,data:[]}));return}if(l.value.userIds.length>1&&!o.every((e,t)=>0===t||e===o[t-1]+1)){m.value=!0,I.value=t("wordSlicerYourCommitMustBeConsecutive");return}e=await s.Lp.send(new s.cf({path:u.y$.wordSlicerSubmit,data:o}))}catch(e){m.value=!0,I.value=String(e)}finally{null!=e&&e.error&&(m.value=!0,I.value=t(e.error)),h.value=!1}},q=async()=>{let e=[],t={};if(l.value.gameStep==d.finished)for(let r of l.value.getResult()){let l=v[r.colorIndex],o=r.right?"#0f0":"#f00";for(let a=r.start;a<=r.end;a++)t[a]=`${l},${o}`,e.push(a)}else for(let r=0;r<v.length;r++){let o=r<l.value.colorIndexToSelectedContentIndex.length?l.value.colorIndexToSelectedContentIndex[r]:null;if(!!o)for(let l=0;l<o.length;l++)t[o[l]]=v[r],e.push(o[l])}n.value=e.sort(),await (0,o.Y3)(()=>{var e,r;null===(e=i.value)||void 0===e||e.initContentIndexToColor(t),null===(r=i.value)||void 0===r||r.initUserInput(l.value.content)})};return(0,o.bv)(()=>{(0,a.$x)().on(a.B_.WordSlicerStatusUpdate,e=>{l.value=e,q()})}),(0,o.Jd)(()=>{(0,a.$x)().off(a.B_.WordSlicerStatusUpdate)}),(e,r)=>{let a=(0,o.up)("nut-button"),s=(0,o.up)("nut-cell"),u=(0,o.up)("nut-cell-group");return(0,o.wg)(),(0,o.iD)("div",k,[(0,o.Wm)(U,{"user-ids":l.value.userIds,"user-id-to-user-name":l.value.userIdToUserName,"current-user-id":y.value,"curr-user-index":l.value.currUserIndex,"game-step":l.value.gameStep,"get-user-color":b},null,8,["user-ids","user-id-to-user-name","current-user-id","curr-user-index","game-step"]),(0,o.Wm)(C.Z,{ref_key:"typingRef",ref:i,content:l.value.content,disabled:!0,"touch-color":H.value,"ignore-case":!1,"change-to-right-case-when-ignore-case":!1,"ignore-punctuation":!1,"ignore-content-indexes":n.value},null,8,["content","touch-color","ignore-content-indexes"]),x.value?((0,o.wg)(),(0,o.iD)("div",T,[(0,o.Wm)(a,{style:{width:"50%"},shape:"square",type:"primary",onClick:$},{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("submit")),1)]),_:1}),(0,o.Wm)(a,{style:{width:"50%"},shape:"square",type:"info",onClick:q},{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("reset")),1)]),_:1})])):(0,o.kq)("",!0),l.value.gameStep===(0,o.SU)(d).started?((0,o.wg)(),(0,o.iD)("div",W,[(0,o.Wm)(s,null,{default:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("wordSlicerEndDesc")),1)]),_:1})])):(0,o.kq)("",!0),l.value.gameStep===(0,o.SU)(d).finished?((0,o.wg)(),(0,o.iD)("div",z,[(0,o.Wm)(u,{title:S.value},{default:(0,o.w5)(()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(l.value.colorIndexToStat,(e,l)=>((0,o.wg)(),(0,o.j4)(s,{key:l},{title:(0,o.w5)(()=>[(0,o._)("span",{style:(0,o.j5)({color:v[l],fontWeight:"bold"})},(0,o.zw)(c[l]),5)]),desc:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("correctChar"))+" "+(0,o.zw)(e.rightCount)+" ",1),r[0]||(r[0]=(0,o._)("br",null,null,-1)),(0,o.Uk)(" "+(0,o.zw)((0,o.SU)(t)("wrongChar"))+" "+(0,o.zw)(e.errorCount)+" ",1),r[1]||(r[1]=(0,o._)("br",null,null,-1)),(0,o.Uk)(" "+(0,o.zw)((0,o.SU)(t)("scoreTitle"))+" ",1),(0,o._)("strong",null,(0,o.zw)(e.score),1)]),_:2},1024))),128))]),_:1},8,["title"]),(0,o.Wm)(u,{title:(0,o.SU)(t)("playerScore")},{default:(0,o.w5)(()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(l.value.userIds,(e,a)=>((0,o.wg)(),(0,o.j4)(s,{key:a},{title:(0,o.w5)(()=>[(0,o._)("span",{style:(0,o.j5)({color:v[_(e)],fontWeight:"bold"})},(0,o.zw)(l.value.userIdToUserName[e]),5)]),desc:(0,o.w5)(()=>[(0,o.Uk)((0,o.zw)((0,o.SU)(t)("scoreTitle"))+" "+(0,o.zw)(D(e))+" ",1),r[2]||(r[2]=(0,o._)("br",null,null,-1))]),_:2},1024))),128))]),_:1},8,["title"])])):(0,o.kq)("",!0)])}}}),H=(0,y.default)(D,[["__scopeId","data-v-680f1446"]]),$=(0,o.aZ)({__name:"word-slicer-game",setup(e){let t;let r=(0,n.yj)(),l=(0,n.tv)(),i=(0,o.iH)("");(0,o.JJ)("editorContent",i);let c=(0,o.iH)(!1);(0,o.JJ)("editorEnable",c);let v=(0,o.f3)("overlayVisible"),w=(0,o.iH)(new p);(0,o.bv)(async()=>{t=a.km.from(r.query),await f(t),s.Lp.controllers.set(u.y$.wordSlicerStatusUpdate,async e=>(w.value=p.fromJson(e.data),await (0,o.Y3)(()=>{(0,a.$x)().emit(a.B_.WordSlicerStatusUpdate,w.value)}),new s.HM)),(0,a.$x)().on(a.B_.RefreshGame,e=>{t=e,f(e)})});let f=async e=>{try{v.value=!0,await g(),await l.replace({query:{verseId:e.verseId}})}catch(e){console.error("Failed to refresh game:",e)}finally{v.value=!1}},g=async()=>{let e=new s.cf({path:u.y$.wordSlicerStatus}),t=await s.Lp.node.send(e);w.value=p.fromJson(t.data),i.value=t.headers.editorContent??"",c.value="1"===t.headers.editorEnable,await (0,o.Y3)(()=>{(0,a.$x)().emit(a.B_.WordSlicerStatusUpdate,w.value)})};return(e,t)=>((0,o.wg)(),(0,o.iD)(o.HY,null,[w.value.gameStep==(0,o.SU)(d).selectRule?((0,o.wg)(),(0,o.j4)(b,{key:0})):(0,o.kq)("",!0),w.value.gameStep==(0,o.SU)(d).started||w.value.gameStep==(0,o.SU)(d).finished?((0,o.wg)(),(0,o.j4)(H,{key:1})):(0,o.kq)("",!0)],64))}}),q=$}}]);