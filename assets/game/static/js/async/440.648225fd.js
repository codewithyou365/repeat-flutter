"use strict";(self.webpackChunktyping=self.webpackChunktyping||[]).push([["440"],{518:function(t,e,s){s.r(e),s.d(e,{default:()=>f});var i=s("464"),r=s("219"),a=s("151"),o=s("480"),n=s("894"),l=s("755"),u=s("238"),h=s("575"),d=s("462"),c=s("234"),g=s("834");let p=(0,i.aZ)({__name:"editor",props:{type:{type:String,required:!0},save:{type:Function,required:!1}},setup(t,e){let{expose:s}=e,r=(0,o.oR)(),a=null,p=(0,i.iH)(null);return h.KD.defineEx("w","w",function(){var e;console.log("test: w"),null===(e=t.save)||void 0===e||e.call(t)}),h.KD.defineEx("x","x",function(){var e;console.log("test: x"),null===(e=t.save)||void 0===e||e.call(t)}),h.KD.defineEx("wq","wq",function(){var e;console.log("test: wq"),null===(e=t.save)||void 0===e||e.call(t)}),(0,i.bv)(()=>{if(p.value){let e=[n.Xy,(0,c._)()];"json"===t.type&&e.push((0,d.AV)()),"dark"===r.getters.currentTheme&&e.push(u.vk),r.getters.currentEnableVim&&(e.push((0,h.dV)()),e.push(g.Q)),(a=new l.tk({doc:"",extensions:e,parent:p.value})).focus()}}),s({getEditorView:()=>a,focus:()=>null==a?void 0:a.focus()}),(t,e)=>((0,i.wg)(),(0,i.iD)("div",{ref_key:"codemirrorParent",ref:p},null,512))}});var _=s("118"),S=s("687"),T=s("759");let N={class:"container"},C={key:0,class:"input-hit"},w={key:1,class:"input-error"},I={key:2,class:"input"},E={key:3,class:"output-finish"},O={key:4,class:"output"},m={key:5,class:"output-error"},v={class:"container"},R=(0,i.aZ)({__name:"input-game",setup(t){let e;let s=(0,i.iH)(null),o=(0,i.iH)([]),n=(0,i.f3)("overlayVisible"),l=(0,i.f3)("tipDialogVisible"),u=(0,i.f3)("tipDialogContent"),{t:h}=(0,_.QT)(),d=0,c=(0,i.iH)([]),g=(0,T.yj)(),R=(0,T.tv)();(0,i.bv)(async()=>{e=r.km.from(g.query),await f(e),(0,r.$x)().on(r.B_.RefreshGame,t=>{e=t,f(t)})}),(0,i.Jd)(()=>{(0,r.$x)().off(r.B_.RefreshGame)});let f=async t=>{try{n.value=!0;let e={gameId:t.id,time:t.time},i=new S.cf({path:a.y$.gameUserHistory,data:e}),r=await S.Lp.node.send(i),l=a.ot.from(r.data);if(o.value=l.list.map(t=>({input:t.input,output:t.output})),d=l.list.length?l.list[l.list.length-1].id:0,c.value=l.list.length?l.list[l.list.length-1].output:[],await R.replace({query:{id:t.id,time:t.time}}),s.value&&l.tips.length>0){let t=s.value.getEditorView();null==t||t.dispatch({changes:{from:0,to:null==t?void 0:t.state.doc.length,insert:l.tips.join(" ")}})}}catch(t){console.error("Failed to refresh game:",t)}finally{n.value=!1}},y=async()=>{let t,r,g="";s.value&&(t=s.value.getEditorView())&&(g=t.state.doc.toString()),n.value=!0;let p=new a.bY;p.gameId=e.id,p.prevId=d,p.input=g;let _=await S.Lp.node.send(new S.cf({path:a.y$.submit,data:p}));if(_.error){l.value=!0,u.value=h(_.error);return}let T=_.data;d=T.id,o.value.push({input:T.input,output:T.output}),c.value=T.output,await (0,i.Y3)(()=>{window.scrollTo(0,document.body.scrollHeight)}),r=T.matchType===a._q.all?T.output.join(" "):"",null==t||t.dispatch({changes:{from:0,to:null==t?void 0:t.state.doc.length,insert:r}}),n.value=!1},k=(0,i.Fl)(()=>{let t=c.value.join("");return 0===t.length||-1!==t.indexOf("•")}),F=t=>{for(let e of t)if("•"===e)return!1;return!0};return(t,e)=>{let r=(0,i.up)("nut-button"),a=(0,i.up)("dev");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",N,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.value,(t,e)=>((0,i.wg)(),(0,i.iD)("div",{key:e,class:"history-item"},[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(t.input,(e,s)=>((0,i.wg)(),(0,i.iD)("div",{key:s,class:"history-word"},[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(e,(e,r)=>((0,i.wg)(),(0,i.iD)("div",{key:r,class:"history-char"},["•"!==e&&t.output[s]&&t.output[s][r]&&t.output[s][r]===e?((0,i.wg)(),(0,i.iD)("span",C,(0,i.zw)(e),1)):"•"!==e?((0,i.wg)(),(0,i.iD)("span",w,(0,i.zw)(e),1)):((0,i.wg)(),(0,i.iD)("span",I,(0,i.zw)(e),1)),t.output[s]&&t.output[s][r]&&F(t.output[s])?((0,i.wg)(),(0,i.iD)("span",E,(0,i.zw)(t.output[s][r]),1)):t.output[s]&&t.output[s][r]?((0,i.wg)(),(0,i.iD)("span",O,(0,i.zw)(t.output[s][r]),1)):((0,i.wg)(),(0,i.iD)("span",m,(0,i.zw)("\xd7")))]))),128))]))),128))]))),128))]),k.value?((0,i.wg)(),(0,i.j4)(a,{key:0},{default:(0,i.w5)(()=>[(0,i.Wm)(p,{type:"txt",save:y,ref_key:"editorComponent",ref:s},null,512),(0,i._)("div",v,[(0,i.Wm)(r,{size:"large",type:"info",onClick:y},{default:(0,i.w5)(()=>[(0,i.Uk)((0,i.zw)((0,i.SU)(h)("confirm")),1)]),_:1})])]),_:1})):(0,i.kq)("",!0)],64)}}}),f=R},687:function(t,e,s){s.d(e,{HM:function(){return n},HQ:function(){return r},Lp:function(){return _},cf:function(){return o},wJ:function(){return h}});var i=s(438);let r=`wss://${window.location.hostname}:${window.location.port}`,a={REQUEST:0,RESPONSE:1};class o{static fromJson(t){return new o({path:t.path??"",headers:t.headers||new Map,data:t.data??""})}constructor({path:t="",headers:e=new Map,data:s=""}={}){(0,i._)(this,"path",void 0),(0,i._)(this,"headers",void 0),(0,i._)(this,"data",void 0),this.path=t,this.headers=e,this.data=s}}class n{static fromJson(t){return new n({headers:t.headers||new Map,data:t.data??"",error:t.error??"",status:t.status??200})}constructor({headers:t=new Map,data:e="",error:s="",status:r=200,age:a=0}={}){(0,i._)(this,"headers",void 0),(0,i._)(this,"data",void 0),(0,i._)(this,"error",void 0),(0,i._)(this,"status",void 0),(0,i._)(this,"age",void 0),this.headers=t,this.data=e,this.error=s,this.status=r,this.age=a}}class l{static fromJson(t){return new l({type:t.type,id:t.id||0,age:t.age||0,request:t.request?o.fromJson(t.request):null,response:t.response?n.fromJson(t.response):null})}constructor({type:t=a.REQUEST,id:e=0,age:s=0,request:r=null,response:o=null}={}){(0,i._)(this,"type",void 0),(0,i._)(this,"id",void 0),(0,i._)(this,"age",void 0),(0,i._)(this,"request",void 0),(0,i._)(this,"response",void 0),this.type=t,this.id=e,this.age=s,this.request=r,this.response=o}}class u{receive(t){if(t.age!==this.age){console.log(`[ws] ignoring message - age mismatch: ${t.age} vs ${this.age}`);return}let e=this.sendId2Res.get(t.id);e&&(t.response.age=this.age,e.resolve(t.response),this.sendId2Res.delete(t.id)),this.sendId2Log.get(t.id)&&(console.log("[ws] recv :",t),this.sendId2Log.delete(t.id))}async send(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this.sendId++;let s=this.sendId,i=this.age,r=new l({id:s,age:i,type:a.REQUEST,request:t});e&&console.log("[ws] send :",r),this.webSocket.send(JSON.stringify(r));let o=this._createCompleter();this.sendId2Res.set(s,o),this.sendId2Log.set(s,e);let u=setTimeout(()=>{if(this.sendId2Res.delete(s)){this.sendId2Log.delete(s);let t=new Map;o.resolve(new n({headers:t,error:"timeout",status:504,age:i}))}},1e4);try{return await o.promise}finally{clearTimeout(u),this.sendId2Res.delete(s),this.sendId2Log.delete(s)}}_createCompleter(){let t,e;return{promise:new Promise((s,i)=>{t=s,e=i}),resolve:t,reject:e}}constructor(t,e){(0,i._)(this,"sendId",void 0),(0,i._)(this,"sendId2Res",void 0),(0,i._)(this,"sendId2Log",void 0),(0,i._)(this,"webSocket",void 0),(0,i._)(this,"age",void 0),this.sendId=0,this.sendId2Res=new Map,this.sendId2Log=new Map,this.webSocket=t,this.age=e}}let h={INIT:0,CONNECT_START:1,CONNECT_FAILED:2,CONNECT_FINISH:3,CONNECT_CLOSE:4,STOP_START:5,STOP_FINISH:6,STOP_FOR_RECONNECT_START:7,STOP_FOR_RECONNECT_FINISH:8},d=new Map([[0,"INIT"],[1,"CONNECT_START"],[2,"CONNECT_FAILED"],[3,"CONNECT_FINISH"],[4,"CONNECT_CLOSE"],[5,"STOP_START"],[6,"STOP_FINISH"],[7,"STOP_FOR_RECONNECT_START"],[8,"STOP_FOR_RECONNECT_FINISH"]]),c=new Map;function g(t,e,s){let i=new Map;for(let t of s)i.set(t,!0);c.set(t,{to:t,incAge:e,from:i})}g(h.INIT,!1,[]),g(h.CONNECT_START,!0,[h.INIT,h.STOP_FOR_RECONNECT_FINISH,h.CONNECT_CLOSE]),g(h.CONNECT_FAILED,!1,[h.CONNECT_START,h.CONNECT_FINISH]),g(h.CONNECT_FINISH,!1,[h.CONNECT_START]),g(h.CONNECT_CLOSE,!0,[h.CONNECT_FINISH]),g(h.STOP_START,!0,[h.CONNECT_FAILED,h.CONNECT_FINISH]),g(h.STOP_FINISH,!0,[h.STOP_START]),g(h.STOP_FOR_RECONNECT_START,!0,[h.CONNECT_FAILED,h.CONNECT_FINISH]),g(h.STOP_FOR_RECONNECT_FINISH,!0,[h.STOP_FOR_RECONNECT_START]);class p{constructor(){(0,i._)(this,"url",""),(0,i._)(this,"statusChange",()=>{}),(0,i._)(this,"heartSender",async()=>new n({status:200})),(0,i._)(this,"reason","")}}let _=new class t{async _loopHeart(){this.heart&&clearTimeout(this.heart);let t=-1;try{let e=await this.heartSender();t=e.age,200===e.status&&""===e.error?this.heart=setTimeout(()=>{this._loopHeart()},2e3):t===this.age&&this.stop(!0,"heart error:"+e.error)}catch(e){t===this.age&&this.stop(!0,"heart exception")}}async send(t){return this.node?await this.node.send(t):null}start(t,e,s){if(this.status!==h.INIT&&this.status!==h.CONNECT_CLOSE&&this.status!==h.STOP_FOR_RECONNECT_FINISH)return this.logger(`[ws] start: status error :${d.get(this.status)}`),!1;{let i=new p;return i.url=t,i.statusChange=e,i.heartSender=s,this.setStatus(h.CONNECT_START,i),!0}}stop(t,e){if(this.status!=h.CONNECT_FAILED&&this.status!=h.CONNECT_FINISH)return this.logger(`[ws] stop: status error :${d.get(this.status)} ${e}`),!1;{let s=new p;return s.reason=e,t?this.setStatus(h.STOP_FOR_RECONNECT_START,s):this.setStatus(h.STOP_START,s),!0}}_close(){this.node.webSocket.close()}_start(t,e,s){this.url=t,this.statusChange=e,this.heartSender=s;let i=new WebSocket(t);this.node=new u(i,this.age),i.onmessage=async t=>{if(this.status===h.CONNECT_FINISH)try{let e=t.data,s=l.fromJson(JSON.parse(e));if(s.type===a.RESPONSE){if(s.age!==this.age)return;this.node.receive(s)}else s.type===a.REQUEST?(console.log("[ws] recv :",s),await this._responseHandler(this.controllers,s,i)):(console.log("[ws] recv :",s),this.logger(`Unknown message type: ${s.type}`))}catch(t){this.logger(`Error handling WebSocket message: ${t}`)}},i.onclose=t=>{this.status===h.CONNECT_FINISH?this.setStatus(h.CONNECT_CLOSE,null):this.status===h.STOP_START?this.setStatus(h.STOP_FINISH,null):this.status===h.STOP_FOR_RECONNECT_START?this.setStatus(h.STOP_FOR_RECONNECT_FINISH,null):this.logger(`[ws] socket.onclose: status error :${d.get(this.status)}`)},i.onerror=t=>{this.status==h.CONNECT_START||this.status==h.CONNECT_FINISH?this.setStatus(h.CONNECT_FAILED,null):this.logger(`[ws] socket.onerror: status error :${d.get(this.status)}`)},i.onopen=()=>{this.status==h.CONNECT_START?this.setStatus(h.CONNECT_FINISH,null):this.logger(`[ws] socket.onopen: status error :${d.get(this.status)}`)}}setStatus(t,e){let s=c.get(t);if(void 0===s)throw Error(`Unknown status: ${t}`);if(!s.from.get(this.status)){this.logger(`[ws] status error : cant from ${d.get(this.status)} to ${d.get(t)} ${null==e?void 0:e.reason}`);return}switch(s.incAge&&this.age++,this.logger(`[ws] status from ${d.get(this.status)} to ${d.get(t)} ${null==e?void 0:e.reason}`),this.status=t,t){case h.CONNECT_START:this._start(e.url,e.statusChange,e.heartSender);break;case h.CONNECT_FAILED:this.stop(!0,"connect failed");break;case h.CONNECT_FINISH:this._loopHeart();break;case h.STOP_FOR_RECONNECT_START:case h.STOP_START:this._close();break;case h.STOP_FINISH:case h.STOP_FOR_RECONNECT_FINISH:case h.CONNECT_CLOSE:this.heart&&clearTimeout(this.heart),this.retry&&clearTimeout(this.retry),(t===h.STOP_FOR_RECONNECT_FINISH||t===h.CONNECT_CLOSE)&&(this.retry=setTimeout(()=>{this.start(this.url,this.statusChange,this.heartSender)},1e3))}this.statusChange(this.status)}async _responseHandler(t,e,s){let i;let r=e.request,o=r&&t.get(r.path);if(o)try{i=await o(r)||new n({status:501})}catch(e){let t;i=new n({status:500,error:t=e instanceof Error?e.message:String(e)})}else i=new n({status:404});let u=new l({id:e.id,type:a.RESPONSE,response:i});s.send(JSON.stringify(u))}constructor(t=console.log){(0,i._)(this,"logger",void 0),(0,i._)(this,"age",0),(0,i._)(this,"node",void 0),(0,i._)(this,"status",h.INIT),(0,i._)(this,"url",""),(0,i._)(this,"retry",null),(0,i._)(this,"statusChange",()=>{}),(0,i._)(this,"controllers",void 0),(0,i._)(this,"heart",null),(0,i._)(this,"heartSender",async()=>new n({status:200})),this.logger=t,this.node=null,this.controllers=new Map}}},151:function(t,e,s){s.d(e,{D$:function(){return o},_q:function(){return u},bY:function(){return l},ot:function(){return n},y$:function(){return a}});var i,r=s(438);let a={kick:"/api/kick",refreshGame:"/api/refreshGame",heart:"/api/heart",loginOrRegister:"/api/loginOrRegister",entryGame:"/api/entryGame",gameUserHistory:"/api/gameUserHistory",gameUserScore:"/api/gameUserScore",gameUserScoreHistory:"/api/gameUserScoreHistory",gameUserScoreMinus:"/api/gameUserScoreMinus",typeGameSettings:"/api/typeGameSettings",typeVerseContent:"/api/typeVerseContent",blankItRightSettings:"/api/blankItRightSettings",blankItRightContent:"/api/blankItRightContent",blankItRightBlank:"/api/blankItRightBlank",blankItRightSubmit:"/api/blankItRightSubmit",wordSlicerStatus:"/api/wordSlicerStatus",wordSlicerStatusUpdate:"/api/wordSlicerStatusUpdate",wordSlicerSelectRole:"/api/wordSlicerSelectRole",wordSlicerChooseColor:"/api/wordSlicerChooseColor",wordSlicerStartGame:"/api/wordSlicerStartGame",wordSlicerSubmit:"/api/wordSlicerSubmit",wordSlicerEdit:"/api/wordSlicerEdit",submit:"/api/submit"};class o{static toGameType(t){switch(t){case o.TYPE.code:return o.TYPE;case o.BLANK_IT_RIGHT.code:return o.BLANK_IT_RIGHT;case o.WORD_SLICER.code:return o.WORD_SLICER;case o.INPUT.code:return o.INPUT;default:return o.NONE}}constructor(t,e){(0,r._)(this,"code",void 0),(0,r._)(this,"path",void 0),this.code=t,this.path=e}}(0,r._)(o,"NONE",new o(0,"")),(0,r._)(o,"TYPE",new o(1,"/game/type-game")),(0,r._)(o,"BLANK_IT_RIGHT",new o(2,"/game/blank-it-right-game")),(0,r._)(o,"WORD_SLICER",new o(3,"/game/word-slicer-game")),(0,r._)(o,"INPUT",new o(4,"/game/input-game"));class n{static from(t){let e=new n;return e.list=t.list,e.tips=t.tips,e}constructor(){(0,r._)(this,"list",void 0),(0,r._)(this,"tips",void 0),this.list=[],this.tips=[]}}class l{static from(t){let e=new l;return e.gameId=t.gameId||0,e.prevId=t.prevId||0,e.input=t.input||"",e}constructor(){(0,r._)(this,"gameId",void 0),(0,r._)(this,"prevId",void 0),(0,r._)(this,"input",void 0),this.gameId=0,this.prevId=0,this.input=""}}var u=((i={})[i.word=0]="word",i[i.single=1]="single",i[i.all=2]="all",i)}}]);