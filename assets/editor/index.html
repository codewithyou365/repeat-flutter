<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Edit Book</title>
    <style>
        #editor {
            width: 100%;
            height: 400px;
        }

        label {
            font-family: sans-serif;
            font-size: 14px;
        }

        .commit-btn {
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            padding: 10px 22px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 15px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .commit-btn:hover {
            background-color: #45a049;
        }

        .commit-btn:active {
            transform: scale(0.97);
        }

        .container {
            display: flex;
            flex-direction: row;
        }

        #menu {
            width: 20%;
            padding: 10px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            height: 400px;
            font-family: sans-serif;
        }

        #editor-container {
            width: 80%;
        }

        ul {
            list-style-type: none;
            padding-left: 20px;
        }

        li.active {
            background-color: #ffff99;
        }
    </style>
    <script src="/ace.js"></script>
    <script src="/keybinding-vim.min.js"></script>
    <script src="/json-source-map.js"></script>
</head>
<body>
<h2>Edit Book
    <label>
        <input type="checkbox" id="vimToggle" onchange="toggleVimMode()"> Enable Vim Mode
    </label>
    <button class="commit-btn" onclick="formatJSON()">Format JSON</button>
</h2>
<div class="container">
    <div id="menu"></div>
    <div id="editor-container">
        <div id="editor"></div>
    </div>
</div>
<br/>
<button class="commit-btn" onclick="commit()">Commit</button>

<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/json");
    editor.setTheme("ace/theme/github");
    editor.commands.addCommand({
        name: "format",
        bindKey: {win: "Ctrl-S", mac: "Cmd-S"},
        exec: function (_) {
            formatJSON();
        }
    });
    // Define custom Vim ex command for formatting
    var Vim = ace.require("ace/keyboard/vim").Vim;
    Vim.defineEx("fmt", "fmt", function (_, __) {
        formatJSON();
    });
    Vim.map("<Space>", "<Leader>", "normal");
    Vim.mapCommand("<Leader>fd", "action", "aceCommand", {name: "format"}, {context: "normal"});

    function toggleVimMode() {
        if (document.getElementById('vimToggle').checked) {
            editor.setKeyboardHandler("ace/keyboard/vim");
        } else {
            editor.setKeyboardHandler(null);
        }
    }

    function formatJSON() {
        var currentValue = editor.getValue();
        try {
            var parsed = JSON.parse(currentValue);
            var cursor = editor.getCursorPosition();
            editor.setValue(JSON.stringify(parsed, null, 2), -1);
            editor.scrollToLine(cursor.row + 1, true, true, () => {
            });
            editor.gotoLine(cursor.row + 1, cursor.column, true);
            editor.focus();
        } catch (e) {
            alert("Invalid JSON: " + e.message);
        }
    }

    var clickedMenu = false;

    function generateMenu() {
        const menuDiv = document.getElementById('menu');
        menuDiv.innerHTML = ''; // Clear existing menu
        try {
            const bookData = JSON.parse(editor.getValue());
            const map = jsonSourceMap.parse(editor.getValue());
            const pointers = map.pointers;

            if (bookData && bookData.c && Array.isArray(bookData.c)) {
                const menuList = document.createElement('ul');
                bookData.c.forEach((chapter, chapterIndex) => {
                    const chapterPath = `/c/${chapterIndex}`;
                    const chapterPointer = pointers[chapterPath];
                    if (chapterPointer) {
                        const chapterLine = chapterPointer.value.line; // 0-based
                        const chapterItem = document.createElement('li');
                        chapterItem.id = `chapter-${chapterIndex}`;
                        chapterItem.textContent = `Chapter ${chapterIndex}`;
                        chapterItem.style.cursor = 'pointer';
                        chapterItem.onclick = (event) => {
                            event.stopPropagation();
                            editor.scrollToLine(chapterLine, true, true, () => {
                            });
                            editor.gotoLine(chapterLine + 1, 0, true);
                            editor.focus();
                            clickedMenu = true;
                        };
                        menuList.appendChild(chapterItem);

                        if (chapter.v && Array.isArray(chapter.v)) {
                            const verseList = document.createElement('ul');
                            chapter.v.forEach((verse, verseIndex) => {
                                const versePath = `/c/${chapterIndex}/v/${verseIndex}`;
                                const versePointer = pointers[versePath];
                                if (versePointer) {
                                    const verseLine = versePointer.value.line;
                                    const verseItem = document.createElement('li');
                                    verseItem.id = `verse-${chapterIndex}-${verseIndex}`;
                                    verseItem.textContent = `Verse ${verseIndex}`;
                                    verseItem.style.cursor = 'pointer';
                                    verseItem.onclick = (event) => {
                                        event.stopPropagation();
                                        editor.scrollToLine(verseLine, true, true, () => {
                                        });
                                        editor.gotoLine(verseLine + 1, 0, true);
                                        editor.focus();
                                        clickedMenu = true;
                                    };
                                    verseList.appendChild(verseItem);
                                }
                            });
                            chapterItem.appendChild(verseList);
                        }
                    }
                });
                menuDiv.appendChild(menuList);
            }
        } catch (err) {
            console.error("Error parsing JSON for menu:", err);
        }
    }

    function updateMenuHighlight() {
        try {
            const bookData = JSON.parse(editor.getValue());
            const map = jsonSourceMap.parse(editor.getValue());
            const pointers = map.pointers;
            const currentRow = editor.selection.getCursor().row;

            // Remove existing active classes
            document.querySelectorAll('#menu li.active').forEach(el => el.classList.remove('active'));

            // Find current chapter and verse
            let selectedChapter = -1;
            let selectedVerse = -1;
            for (let chapterIndex = 0; chapterIndex < bookData.c.length; chapterIndex++) {
                const chapterPath = `/c/${chapterIndex}`;
                const pointer = pointers[chapterPath];
                if (pointer && currentRow >= pointer.value.line && currentRow <= pointer.valueEnd.line) {
                    selectedChapter = chapterIndex;

                    const chapter = bookData.c[chapterIndex];
                    if (chapter.v && Array.isArray(chapter.v)) {
                        for (let verseIndex = 0; verseIndex < chapter.v.length; verseIndex++) {
                            const versePath = `/c/${chapterIndex}/v/${verseIndex}`;
                            const vPointer = pointers[versePath];
                            if (vPointer && currentRow >= vPointer.value.line && currentRow <= vPointer.valueEnd.line) {
                                selectedVerse = verseIndex;
                                break;
                            }
                        }
                    }
                    break;
                }
            }

            let activeEl = null;
            if (selectedVerse !== -1) {
                const verseEl = document.getElementById(`verse-${selectedChapter}-${selectedVerse}`);
                if (verseEl) {
                    verseEl.classList.add('active');
                    activeEl = verseEl;
                }
            } else if (selectedChapter !== -1) {
                const chapterEl = document.getElementById(`chapter-${selectedChapter}`);
                if (chapterEl) {
                    chapterEl.classList.add('active');
                    activeEl = chapterEl;
                }
            }

            if (activeEl) {
                if (clickedMenu) {
                    clickedMenu = false;
                } else {
                    activeEl.scrollIntoView({block: 'center'});
                }
            }

            const newUrl = new URL(window.location);
            if (selectedChapter !== -1) {
                newUrl.searchParams.set('c', selectedChapter);
                if (selectedVerse !== -1) {
                    newUrl.searchParams.set('v', selectedVerse);
                } else {
                    newUrl.searchParams.delete('v');
                }
            } else {
                newUrl.searchParams.delete('c');
                newUrl.searchParams.delete('v');
            }
            history.pushState({}, '', newUrl);
        } catch (err) {
            console.error("Error updating menu highlight:", err);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    let timeout;
    editor.on('change', () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            generateMenu();
            updateMenuHighlight();
        }, 500);
    });

    editor.on('changeSelection', debounce(updateMenuHighlight, 100));

    initBook();

    async function initBook() {
        try {
            const res = await fetch('/book', {
                method: 'POST',
            });
            const initialValue = await res.text();
            try {
                var parsed = JSON.parse(initialValue);
                editor.setValue(JSON.stringify(parsed, null, 2), -1);
            } catch (e) {
                console.error("Error pretty-printing JSON:", e);
            }
            generateMenu();

            const urlParams = new URLSearchParams(window.location.search);
            const c = urlParams.get('c');
            const v = urlParams.get('v');
            if (c) {
                const chapterIndex = parseInt(c, 10);
                if (!isNaN(chapterIndex)) {
                    const map = jsonSourceMap.parse(editor.getValue());
                    const pointers = map.pointers;
                    const chapterPath = `/c/${chapterIndex}`;
                    const chapterPointer = pointers[chapterPath];
                    if (chapterPointer) {
                        editor.scrollToLine(chapterPointer.value.line, true, true, () => {});
                        editor.gotoLine(chapterPointer.value.line + 1, 0, true);
                        editor.focus();
                    }
                    if (v) {
                        const verseIndex = parseInt(v, 10);
                        if (!isNaN(verseIndex)) {
                            const versePath = `/c/${chapterIndex}/v/${verseIndex}`;
                            const versePointer = pointers[versePath];
                            if (versePointer) {
                                editor.scrollToLine(versePointer.value.line, true, true, () => {});
                                editor.gotoLine(versePointer.value.line + 1, 0, true);
                                editor.focus();
                            }
                        }
                    }
                }
            }
            updateMenuHighlight();
        } catch (err) {
            alert("Error sending data: " + err);
        }
    }

    async function commit() {
        const data = editor.getValue();
        try {
            const res = await fetch('/upload', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: data
            });
            const text = await res.text();
            alert("Server response: " + text);
            location.reload();
        } catch (err) {
            alert("Error sending data: " + err);
        }
    }
</script>
</body>
</html>